name: Video Upload Workflow

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Video URL'
        required: true
        type: string
      message_id:
        description: 'Discord message ID (optional)'
        required: false
        type: string

jobs:
  download-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup yt-dlp with cache
        uses: AnimMouse/setup-yt-dlp@v3
        with:
          cache: 'true'

      - name: Resolve final URL
        id: resolve
        run: |
          FINAL_URL=$(curl -Ls -o /dev/null -w '%{url_effective}' "${{ inputs.url }}")
          echo "FINAL_URL=$FINAL_URL" >> $GITHUB_ENV
          echo "âœ… Resolved final URL: $FINAL_URL"

      - name: Download video with audio (best format)
        id: download
        run: |
          echo "ðŸ“¥ Downloading from: $FINAL_URL"
          yt-dlp --verbose --format "bestvideo[ext=mp4]+bestaudio[ext=m4a]/best" --merge-output-format mp4 --no-playlist -o "video.%(ext)s" "$FINAL_URL"
          ls -lh video.*
          FILE=$(ls video.* | head -n1)
          echo "FILE=$FILE" >> $GITHUB_ENV

      - name: Upload to Catbox
        id: upload
        run: |
          echo "ðŸ“¤ Uploading $FILE to Catbox..."
          URL=$(curl -s -F "reqtype=fileupload" -F "file=@$FILE" https://catbox.moe/user/api.php)
          echo "URL=$URL" >> $GITHUB_OUTPUT
          echo "âœ… Uploaded URL: $URL"
          rm -f video.*

      - name: Send message to Discord
        run: |
          CONTENT="âœ… Video uploaded: ${{ steps.upload.outputs.URL }}"
          if [ -n "${{ inputs.message_id }}" ]; then
            CONTENT="$CONTENT (reply to message ID: ${{ inputs.message_id }})"
          fi
          echo "ðŸ“£ Sending to Discord: $CONTENT"
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{\"content\":\"$CONTENT\"}"
