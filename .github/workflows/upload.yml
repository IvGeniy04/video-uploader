name: Upload Video v1.7

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Video URL to download'
        required: true
      message_id:
        description: 'Discord message ID'
        required: false

jobs:
  upload_video:
    runs-on: ubuntu-latest
    env:
      CATBOX_TOKEN: ${{ secrets.CATBOX_TOKEN }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
      DISCORD_GUILD_ID: ${{ secrets.DISCORD_GUILD_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup yt-dlp with aria2 (cached) v1.7
        uses: AnimMouse/setup-yt-dlp@v3
        with:
          aria2: true
        # Версія yt-dlp не вказана, щоб використовувався кеш або дефолтна, щоб уникнути помилок завантаження

      - name: Setup ffmpeg (cached)
        uses: AnimMouse/setup-yt-dlp/ffmpeg@v3

      - name: Resolve final URL
        id: resolve_url
        run: |
          FINAL_URL=$(curl -Ls -o /dev/null -w '%{url_effective}' "${{ github.event.inputs.url }}")
          echo "Resolved final URL: $FINAL_URL"
          echo "final_url=$FINAL_URL" >> $GITHUB_OUTPUT

      - name: Download video with yt-dlp v1.7
        run: |
          echo "📥 Downloading from: '${{ steps.resolve_url.outputs.final_url }}'"
          yt-dlp --verbose --format "bestvideo[ext=mp4]+bestaudio[ext=m4a]/best" --merge-output-format mp4 --no-playlist -o "video.%(ext)s" "${{ steps.resolve_url.outputs.final_url }}"
          ls -lh video.*

      - name: Upload to Catbox v1.7
        id: upload
        run: |
          FILE=$(ls video.* | head -n1)
          echo "📤 Uploading $FILE to Catbox..."
          RESPONSE=$(curl -sF "reqtype=fileupload" -F "fileToUpload=@$FILE" https://catbox.moe/user/api.php)
          echo "Catbox response: $RESPONSE"
          echo "upload_url=$RESPONSE" >> $GITHUB_OUTPUT

      - name: Send Discord notification v1.7
        run: |
          CONTENT="✅ Video uploaded: ${{ steps.upload.outputs.upload_url }}"
          echo "📣 Sending to Discord: $CONTENT (reply to message ID: ${{ github.event.inputs.message_id || 'none' }})"
          curl -X POST -H "Content-Type: application/json" -d "{\"content\":\"$CONTENT\"}" $DISCORD_WEBHOOK_URL
