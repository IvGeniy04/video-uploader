name: Upload Video to Catbox

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Video URL'
        required: true
        type: string
      message_id:
        description: 'Discord Message ID'
        required: false
        type: string

jobs:
  upload:
    runs-on: ubuntu-latest
    container: jrottenberg/ffmpeg:ubuntu
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install yt-dlp requests

      - name: Warm up Facebook
        if: contains(inputs.url, 'facebook.com') || contains(inputs.url, 'fb.watch')
        run: |
          curl -s -L -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" --max-time 30 "${{ inputs.url }}" > /dev/null 2>&1 || true
          sleep 3

      - name: Check content type
        id: content_check
        run: >
          INFO=$(yt-dlp --dump-json --no-check-certificate "${{ inputs.url }}" 2>/dev/null);
          if [ -z "$INFO" ]; then
            echo "type=error" >> $GITHUB_OUTPUT;
            exit 1;
          fi;
          HAS_VIDEO=$(echo "$INFO" | python3 -c "
import sys, json;
try:
  info = json.load(sys.stdin);
  formats = info.get('formats', []);
  if any(f.get('vcodec', 'none') != 'none' for f in formats):
    print('video');
  elif any(f.get('acodec', 'none') != 'none' for f in formats):
    print('audio');
  elif info.get('thumbnail'):
    print('image');
  else:
    print('text');
except:
  print('unknown');
");
          echo "type=$HAS_VIDEO" >> $GITHUB_OUTPUT;
          if [ "${{ secrets.DISCORD_RESULTS_WEBHOOK }}" != "" ] && [ -n "${{ inputs.message_id }}" ]; then
            case "$HAS_VIDEO" in
              "video")
                EMOJI="ðŸ“º";
                DESC="Ð²Ñ–Ð´ÐµÐ¾";
                ;;
              "image")
                EMOJI="ðŸ–¼ï¸";
                DESC="ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÐ°";
                ;;
              "audio")
                EMOJI="ðŸŽµ";
                DESC="Ð°ÑƒÐ´Ñ–Ð¾";
                ;;
              "text")
                EMOJI="ðŸ“";
                DESC="Ñ‚ÐµÐºÑÑ‚";
                ;;
              *)
                EMOJI="â“";
                DESC="Ð½ÐµÐ²Ñ–Ð´Ð¾Ð¼Ð¸Ð¹ Ñ‚Ð¸Ð¿";
                ;;
            esac;
            curl -X POST -H "Content-Type: application/json"
            -d "{\"content\": \"$EMOJI Ð’Ð¸Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¾: $DESC Ð´Ð»Ñ message ${{ inputs.message_id }}\"}"
            "${{ secrets.DISCORD_RESULTS_WEBHOOK }}";
          fi

      - name: Skip non-video
        if: steps.content_check.outputs.type != 'video'
        run: |
          echo "ðŸš« ÐÐµ Ð²Ñ–Ð´ÐµÐ¾ â€” Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ñ"
          exit 0

      - name: Download and upload
        id: catbox
        run: |
          yt-dlp \
            --format "bestvideo+bestaudio" \
            --merge-output-format mp4 \
            --no-check-certificate \
            --output "video.mp4" \
            "${{ inputs.url }}" && \
          LINK=$(curl -s -H "Expect:" \
            -F "reqtype=fileupload" \
            -F "fileToUpload=@video.mp4" \
            https://catbox.moe/user/api.php) && \
          [[ "$LINK" =~ ^https:// ]] && \
          echo "link=$LINK" >> $GITHUB_OUTPUT || \
          exit 1

      - name: Send result to results channel
        if: success()
        run: |
          MESSAGE_ID="${{ inputs.message_id }}"
          if [ "${{ secrets.DISCORD_RESULTS_WEBHOOK }}" != "" ] && [ -n "$MESSAGE_ID" ]; then
            curl -X POST -H "Content-Type: application/json"
            -d "{\"content\": \"ðŸ”— Result for message $MESSAGE_ID: ${{ steps.catbox.outputs.link }}\"}"
            "${{ secrets.DISCORD_RESULTS_WEBHOOK }}"
          fi

      - name: Clean up
        if: always()
        run: |
          rm -f video.mp4
