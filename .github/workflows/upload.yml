name: upload_video

on:
  workflow_dispatch:
    inputs:
      message_id:
        description: 'ID of the message to reply to'
        required: false

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: üßæ Checkout
        uses: actions/checkout@v4

      - name: üõ† Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: üß© Setup yt-dlp v3
        uses: AnimMouse/setup-yt-dlp@v3

      - name: üé• Get video file
        run: |
          FILE=$(ls video.* | head -n1)
          echo "Found video file: $FILE"
          echo "FILE=$FILE" >> $GITHUB_ENV

      - name: üì§ Upload to Catbox v1.9
        id: upload
        run: |
          echo "üì§ Uploading $FILE to Catbox..."
          RESPONSE=$(curl -sF "reqtype=fileupload" -F "file=@$FILE" https://catbox.moe/user/api.php)
          echo "Catbox response: $RESPONSE"
          echo "upload_url=$RESPONSE" >> $GITHUB_OUTPUT

      - name: üì£ Send Discord notification v1.9
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          UPLOAD_URL="${{ steps.upload.outputs.upload_url }}"
          MESSAGE_ID="${{ github.event.inputs.message_id }}"
          echo "üì£ Sending to Discord: ‚úÖ Video uploaded: $UPLOAD_URL (reply to message ID: ${MESSAGE_ID:-none})"

          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "‚ùå ERROR: DISCORD_WEBHOOK_URL is not set!"
            exit 1
          fi

          curl -X POST -H "Content-Type: application/json" \
            -d "{\"content\":\"‚úÖ Video uploaded: $UPLOAD_URL\"}" \
            "$DISCORD_WEBHOOK_URL"
