name: Upload Video to Catbox

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Video URL (TikTok, Instagram, Pinterest, etc.)'
        required: true
        type: string
      message_id:
        description: 'Discord Message ID for response tracking'
        required: false
        type: string

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Install yt-dlp with embedded ffmpeg
        run: |
          curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o yt-dlp
          chmod +x yt-dlp
          sudo mv yt-dlp /usr/local/bin/

      - name: Install requests
        run: |
          pip install requests

      - name: Normalize Telegram URL
        run: |
          echo "Original URL: ${{ inputs.url }}"
          export NORMALIZED_URL=$(echo "${{ inputs.url }}" | sed 's|https://t\.me/|https://telegram.org/|')
          echo "Normalized URL: $NORMALIZED_URL"
          echo "NORMALIZED_URL=$NORMALIZED_URL" >> $GITHUB_ENV

      - name: Warm up Facebook
        if: contains(env.NORMALIZED_URL, 'facebook.com') || contains(env.NORMALIZED_URL, 'fb.watch')
        run: |
          curl -s -L -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36" \
            --max-time 30 "$NORMALIZED_URL" > /dev/null 2>&1 || true
          sleep 3

      - name: Check and upload video
        id: catbox
        run: |
          # –û—á–∏—â–∞—î–º–æ URL
          VIDEO_URL="$NORMALIZED_URL"
          VIDEO_URL=$(echo "$VIDEO_URL" | xargs)
          MAX_SIZE_BYTES=$((180 * 1024 * 1024))  # 180 MB

          echo "üîç –û—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –≤—ñ–¥–µ–æ: $VIDEO_URL"
          
          # –û—Ç—Ä–∏–º—É—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ä–æ–∑–º—ñ—Ä—É
          INFO=$(yt-dlp \
            --dump-json \
            --allow-unplayable-formats \
            --extractor-args "pinterest:use_webpage=True" \
            --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36" \
            --no-check-certificate \
            "$VIDEO_URL" 2>/dev/null)

          if [ -z "$INFO" ]; then
            echo "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≤—ñ–¥–µ–æ"
            if [ "${{ secrets.DISCORD_RESULTS_WEBHOOK }}" != "" ]; then
              curl -X POST -H "Content-Type: application/json" \
                -d '{"content": "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤—ñ–¥–µ–æ –¥–ª—è message ${{ inputs.message_id }}"}' \
                ${{ secrets.DISCORD_RESULTS_WEBHOOK }}
            fi
            exit 1
          fi

          FILESIZE=$(echo "$INFO" | python3 -c "import sys, json; print(json.load(sys.stdin).get('filesize', 0))")

          if [ -z "$FILESIZE" ] || [ "$FILESIZE" -eq 0 ]; then
            echo "‚ö†Ô∏è –†–æ–∑–º—ñ—Ä –Ω–µ–≤—ñ–¥–æ–º–∏–π ‚Äî –ø—Ä–æ–±—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏..."
          elif [ "$FILESIZE" -gt "$MAX_SIZE_BYTES" ]; then
            echo "‚ùå –í—ñ–¥–µ–æ –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–µ: –±—ñ–ª—å—à–µ 180 MB"
            if [ "${{ secrets.DISCORD_RESULTS_WEBHOOK }}" != "" ]; then
              curl -X POST -H "Content-Type: application/json" \
                -d '{"content": "‚ùå –í—ñ–¥–µ–æ –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–µ (–º–∞–∫—Å. 180 –ú–ë) –¥–ª—è message ${{ inputs.message_id }}"}' \
                ${{ secrets.DISCORD_RESULTS_WEBHOOK }}
            fi
            exit 1
          fi

          echo "üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –≤–∏–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ Catbox..."
          
          # –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —ñ –æ–¥—Ä–∞–∑—É –≤–∏–≤–∞–Ω—Ç–∞–∂—É—î–º–æ
          OUTPUT_LINK=$(yt-dlp \
            --merge-output-format mp4 \
            --allow-unplayable-formats \
            --extractor-args "pinterest:use_webpage=True" \
            --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36" \
            --no-check-certificate \
            --output - \
            "$VIDEO_URL" | \
            curl -f -s -H "Expect:" \
            -F "reqtype=fileupload" \
            -F "fileToUpload=@-;filename=video.mp4;type=video/mp4" \
            https://catbox.moe/user/api.php)

          # –°—É–≤–æ—Ä–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
          if [[ "$OUTPUT_LINK" =~ ^https://files\.catbox\.moe/.*\.(mp4|webm)$ ]]; then
            echo "‚úÖ –£—Å–ø—ñ—à–Ω–æ: $OUTPUT_LINK"
            echo "link=$OUTPUT_LINK" >> $GITHUB_OUTPUT
          else
            echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–∏–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: –æ—Ç—Ä–∏–º–∞–Ω–æ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å: $OUTPUT_LINK"
            if [ "${{ secrets.DISCORD_RESULTS_WEBHOOK }}" != "" ]; then
              curl -X POST -H "Content-Type: application/json" \
                -d '{"content": "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–∞ Catbox –¥–ª—è message ${{ inputs.message_id }}"}' \
                ${{ secrets.DISCORD_RESULTS_WEBHOOK }}
            fi
            exit 1
          fi

      - name: Send result to results channel
        if: success()
        run: |
          MESSAGE_ID="${{ inputs.message_id }}"
          if [ "${{ secrets.DISCORD_RESULTS_WEBHOOK }}" != "" ] && [ -n "$MESSAGE_ID" ] && [ -n "${{ steps.catbox.outputs.link }}" ]; then
            curl -X POST -H "Content-Type: application/json" \
            -d "{\"content\": \"üîó Result for message $MESSAGE_ID: ${{ steps.catbox.outputs.link }}\"}" \
            ${{ secrets.DISCORD_RESULTS_WEBHOOK }}
          fi
