name: 📤 Upload video to Catbox

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'URL to process'
        required: true
      message_id:
        description: 'Message ID'
        required: true

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
      - name: 🧾 Checkout
        uses: actions/checkout@v4

      - name: 📦 Restore yt-dlp + FFmpeg cache
        uses: actions/cache/restore@v4
        id: cache-restore
        with:
          path: yt-dlp-FFmpeg
          key: yt-dlp-FFmpeg-${{ runner.os }}-${{ hashFiles('.github/cache-version.txt') }}

      - name: 🔽 Setup yt-dlp & FFmpeg
        uses: AnimMouse/setup-yt-dlp@v3
        with:
          ffmpeg: true
          cache: ${{ steps.cache-restore.outputs.cache-hit != 'true' }}

      - name: ⚙️ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 📦 Install dependencies
        run: pip install -r requirements.txt

      - name: 📥 Download video
        run: python scripts/download.py "${{ github.event.inputs.url }}"

      - name: 📤 Upload to Catbox
        run: |
          FILE=$(ls video.* | head -n1)
          echo "📤 Uploading $FILE to Catbox..."
          RESPONSE=$(curl -F "reqtype=fileupload" -F "file=@$FILE" https://catbox.moe/user/api.php)
          echo "Catbox response: $RESPONSE"
          echo "UPLOAD_URL=$RESPONSE" >> $GITHUB_ENV

      - name: 📣 Send result to Discord
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{\"content\": \"✅ Video uploaded: $UPLOAD_URL\", \"message_reference\": {\"message_id\": \"${{ github.event.inputs.message_id }}\"}}" \
            $DISCORD_WEBHOOK_URL
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
