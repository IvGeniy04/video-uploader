name: Fast Social Video Download

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Video URL (Telegram, Facebook, TikTok, Pinterest, Instagram)'
        required: true
        type: string
      message_id:
        description: 'Discord message ID (optional)'
        required: false
        type: string

jobs:
  process:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup yt-dlp + FFmpeg
        uses: AnimMouse/setup-yt-dlp@v3

      - name: Determine URL redirect
        id: resolve
        run: |
          FINAL=$(curl -Ls -o /dev/null -w '%{url_effective}' "${{ github.event.inputs.url }}")
          echo "FINAL_URL=$FINAL" >> $GITHUB_ENV

      - name: Download + merge video
        id: download
        run: |
          echo "Downloading from $FINAL_URL"
          yt-dlp --verbose --format "bestvideo[ext=mp4]+bestaudio[ext=m4a]/best" \
            --merge-output-format mp4 -o video.%(ext)s "$FINAL_URL"
          echo "FILE=$(ls video.* | head -n1)" >> $GITHUB_ENV

      - name: Upload to Catbox
        id: upload
        run: |
          echo "Uploading $FILE"
          LINK=$(curl -s -H "Expect:" -F "reqtype=fileupload" -F "file=@$FILE" https://catbox.moe/user/api.php)
          echo "link=$LINK" >> $GITHUB_OUTPUT
          rm -f "$FILE"

      - name: Send to Discord
        if: steps.upload.outputs.link
        run: |
          CONTENT="Завантажено відео: ${{ steps.upload.outputs.link }}"
          if [ -n "${{ github.event.inputs.message_id }}" ]; then
            CONTENT="$CONTENT (reply to message ${{ github.event.inputs.message_id }})"
          fi
          curl -H "Content-Type: application/json" -X POST -d "{\"content\":\"$CONTENT\"}" ${{ secrets.DISCORD_WEBHOOK_URL }}
