name: Download Social Videos

on:
  workflow_dispatch:
    inputs:
      url:
        description: "Video URL (Telegram/Facebook/TikTok/Pinterest/Instagram)"
        required: true
        type: string
      message_id:
        description: "Discord message ID (optional)"
        required: false
        type: string

jobs:
  download:
    runs-on: ubuntu-latest
    env:
      WEBHOOK: ${{ secrets.DISCORD_RESULTS_WEBHOOK }}

    steps:
      - name: Setup yt-dlp + ffmpeg (caching)
        uses: AnimMouse/setup-yt-dlp@v3

      - name: Check URL source and download accordingly
        id: download
        run: |
          URL="${{ github.event.inputs.url }}"
          HOST=$(echo "$URL" | awk -F/ '{print $3}' | tr '[:upper:]' '[:lower:]')

          case "$HOST" in
            *"t.me"*) TYPE="telegram" ;;
            *"fb.com"*|*"facebook.com"*) TYPE="facebook" ;;
            *"tiktok.com"*) TYPE="tiktok" ;;
            *"pinterest.com"*) TYPE="pinterest" ;;
            *"instagram.com"*) TYPE="instagram" ;;
            *) echo "Unsupported host: $HOST"; exit 1 ;;
          esac

          echo "type=$TYPE" >> $GITHUB_OUTPUT

          yt-dlp --retries 2 --fragment-retries 2 --merge-output-format mp4 \
            --format bestvideo+bestaudio/best --output - "$URL" |
          curl -s -H "Expect:" -F "reqtype=fileupload" -F "fileToUpload=@-;filename=video.mp4;type=video/mp4" \
            https://catbox.moe/user/api.php > link.txt || exit 1

          LINK=$(cat link.txt)
          echo "link=$LINK" >> $GITHUB_OUTPUT

      - name: Notify Discord
        if: always()
        run: |
          TYPE="${{ steps.download.outputs.type }}"
          LINK="${{ steps.download.outputs.link }}"
          MSG_ID="${{ github.event.inputs.message_id }}"

          if [ -z "$LINK" ]; then
            CONTENT="‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—ñ–¥–µ–æ –∑ $TYPE"
          else
            CONTENT="üîó –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑ $TYPE: $LINK"
          fi

          if [ -n "$MSG_ID" ]; then
            CONTENT="$CONTENT –¥–ª—è message $MSG_ID"
          fi

          curl -X POST -H "Content-Type: application/json" \
            -d "{\"content\": \"$CONTENT\"}" \
            "$WEBHOOK"
