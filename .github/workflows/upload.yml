name: upload_video

description: "ðŸ“¤ Upload video to Catbox and post result to Discord"

on:
  workflow_dispatch:
    inputs:
      message_id:
        description: 'ID of the message to reply to'
        required: false
      url:
        description: 'URL to download'
        required: true

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup yt-dlp and FFmpeg
        uses: AnimMouse/setup-yt-dlp@v3

      - name: Cache yt-dlp-FFmpeg
        id: cache-ffmpeg
        uses: actions/cache@v4
        with:
          path: yt-dlp-FFmpeg
          key: yt-dlp-FFmpeg-237717375-Linux

      - name: Download yt-dlp-FFmpeg if cache missed
        if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
        run: |
          mkdir -p yt-dlp-FFmpeg
          curl -L https://github.com/AnimMouse/setup-yt-dlp/releases/download/237717375/yt-dlp-FFmpeg-Linux.tar.zst -o ffmpeg.tar.zst
          tar --use-compress-program=unzstd -xvf ffmpeg.tar.zst -C yt-dlp-FFmpeg

      - name: Add tool cache to PATH
        run: echo "$(pwd)/yt-dlp-FFmpeg" >> $GITHUB_PATH

      - name: Download video using yt-dlp
        run: |
          yt-dlp "${{ github.event.inputs.url }}" -o video.%(ext)s

      - name: Find downloaded file
        id: getfile
        run: |
          FILE=$(ls video.* | head -n1)
          echo "file=$FILE" >> $GITHUB_OUTPUT

      - name: Upload to Catbox
        id: upload
        run: |
          FILE=${{ steps.getfile.outputs.file }}
          echo "ðŸ“¤ Uploading $FILE to Catbox..."
          RESPONSE=$(curl -s -F "reqtype=fileupload" -F "file=@$FILE" https://catbox.moe/user/api.php)
          echo "Catbox response: $RESPONSE"
          echo "url=$RESPONSE" >> $GITHUB_OUTPUT

      - name: Send to Discord via curl webhook
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H 'Content-Type: application/json' \
            -d "{\"content\":\"âœ… Video uploaded: ${{ steps.upload.outputs.url }} (reply to message ID: ${{ github.event.inputs.message_id }})\"}"
