name: Upload Video v1.6

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'URL to download'
        required: true
      message_id:
        description: 'Discord message ID (optional)'
        required: false

jobs:
  upload_video:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Cache yt-dlp cache directory
        uses: actions/cache@v4
        with:
          path: ~/.cache/yt-dlp
          key: yt-dlp-cache-${{ runner.os }}-${{ hashFiles('**/upload.yml') }}
          restore-keys: |
            yt-dlp-cache-${{ runner.os }}-

      - name: Setup yt-dlp with aria2
        uses: AnimMouse/setup-yt-dlp@v3
        with:
          version: stable
          aria2: true

      - name: Download video
        run: |
          FINAL_URL=$(curl -Ls -o /dev/null -w '%{url_effective}' "${{ github.event.inputs.url }}")
          echo "üì• Downloading from: $FINAL_URL"
          yt-dlp --verbose --format "bestvideo[ext=mp4]+bestaudio[ext=m4a]/best" --merge-output-format mp4 --no-playlist -o "video.%(ext)s" "$FINAL_URL"
          ls -lah video.*

      - name: Upload video to Catbox
        id: upload
        run: |
          FILE=$(ls video.* | head -n1)
          echo "üì§ Uploading $FILE to Catbox..."
          RESPONSE=$(curl -F "reqtype=fileupload" -F "fileToUpload=@$FILE" https://catbox.moe/user/api.php)
          echo "‚úÖ Uploaded URL: $RESPONSE"
          echo "::set-output name=url::$RESPONSE"

      - name: Send Discord message
        run: |
          UPLOAD_URL="${{ steps.upload.outputs.url }}"
          MESSAGE="‚úÖ Video uploaded: $UPLOAD_URL"
          if [ -n "${{ github.event.inputs.message_id }}" ]; then
            MESSAGE="‚úÖ Video uploaded: $UPLOAD_URL (–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: https://discord.com/channels/YOUR_SERVER_ID/YOUR_CHANNEL_ID/${{ github.event.inputs.message_id }})"
          fi
          echo "üì£ Sending to Discord: $MESSAGE"
          curl -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}" \
               -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\":\"$MESSAGE\"}" \
               "https://discord.com/api/v10/channels/YOUR_CHANNEL_ID/messages"
