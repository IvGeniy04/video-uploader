name: Upload Video v1.8

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Video URL to download'
        required: true
      message_id:
        description: 'Discord message ID'
        required: false

jobs:
  upload_video:
    runs-on: ubuntu-latest
    env:
      CATBOX_TOKEN: ${{ secrets.CATBOX_TOKEN }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup yt-dlp with aria2 (cached) v1.8
        uses: AnimMouse/setup-yt-dlp@v3
        with:
          aria2: true

      - name: Setup ffmpeg (cached)
        uses: AnimMouse/setup-yt-dlp/ffmpeg@v3

      - name: Resolve final URL
        id: resolve_url
        run: |
          FINAL_URL=$(curl -Ls -o /dev/null -w '%{url_effective}' "${{ github.event.inputs.url }}")
          echo "Resolved final URL: $FINAL_URL"
          echo "final_url=$FINAL_URL" >> $GITHUB_OUTPUT

      - name: Download video with yt-dlp v1.8
        run: |
          echo "üì• Downloading from: '${{ steps.resolve_url.outputs.final_url }}'"
          yt-dlp --verbose --format "bestvideo[ext=mp4]+bestaudio[ext=m4a]/best" --merge-output-format mp4 --no-playlist -o "video.%(ext)s" "${{ steps.resolve_url.outputs.final_url }}"
          ls -lh video.*

      - name: Upload to Catbox v1.8
        id: upload
        run: |
          FILE=$(ls video.* | head -n1)
          echo "üì§ Uploading $FILE to Catbox..."
          RESPONSE=$(curl -sF "reqtype=fileupload" -F "fileToUpload=@$FILE" https://catbox.moe/user/api.php)
          echo "Catbox response: $RESPONSE"
          echo "upload_url=$RESPONSE" >> $GITHUB_OUTPUT

      - name: Send Discord notification v1.8
        run: |
          UPLOAD_URL="${{ steps.upload.outputs.upload_url }}"
          MESSAGE_ID="${{ github.event.inputs.message_id }}"
          echo "üì£ Sending to Discord: ‚úÖ Video uploaded: $UPLOAD_URL (reply to message ID: ${MESSAGE_ID:-none})"
          # –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–µ–Ω reply, –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ø–æ–ª–µ "message_reference", –∞–ª–µ —Ç—É—Ç –ø—Ä–æ—Å—Ç–∏–π –ø–æ—Å—Ç
          curl -X POST -H "Content-Type: application/json" -d "{\"content\":\"‚úÖ Video uploaded: $UPLOAD_URL\"}" $DISCORD_WEBHOOK_URL
