name: Upload Video to Catbox

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Video URL'
        required: true
        type: string
      message_id:
        description: 'Discord Message ID'
        required: false
        type: string

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install ffmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg

      - name: Install dependencies
        run: |
          pip install git+https://github.com/yt-dlp/yt-dlp.git
          pip install requests

      - name: Warm up Facebook
        if: contains(inputs.url, 'facebook.com') || contains(inputs.url, 'fb.watch')
        run: >
          curl -s -L -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
          --max-time 30 "${{ inputs.url }}" > /dev/null 2>&1 || true
          sleep 3

      - name: Check content type
        id: content_check
        run: |
          INFO=$(yt-dlp --dump-json --simulate "${{ inputs.url }}" 2>/dev/null) || echo ""
          
          if [ -z "$INFO" ]; then
            echo "type=error" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          HAS_VIDEO=$(python3 << EOF
import sys, json
try:
    info = json.loads('''$INFO''')
    formats = info.get('formats', [])
    if any(f.get('vcodec', 'none') != 'none' for f in formats):
        print('video')
    elif any(f.get('acodec', 'none') != 'none' for f in formats):
        print('audio')
    elif info.get('thumbnail'):
        print('image')
    else:
        print('text')
except Exception:
    print('unknown')
EOF
)
          echo "type=$HAS_VIDEO" >> $GITHUB_OUTPUT

      - name: Handle non-video content
        if: steps.content_check.outputs.type != 'video'
        run: |
          TYPE="${{ steps.content_check.outputs.type }}"
          MSG_ID="${{ inputs.message_id }}"
          WEBHOOK="${{ secrets.DISCORD_RESULTS_WEBHOOK }}"
          
          case "$TYPE" in
            "image")
              CONTENT="üñºÔ∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞"
              ;;
            "audio")
              CONTENT="üéµ –ê—É–¥—ñ–æ"
              ;;
            "text")
              CONTENT="üìù –¢–µ–∫—Å—Ç–æ–≤–∏–π –ø–æ—Å—Ç"
              ;;
            "error")
              CONTENT="‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–Ω—Ç–µ–Ω—Ç"
              ;;
            *)
              CONTENT="üìÑ –ù–µ–≤—ñ–¥–æ–º–∏–π —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç—É"
              ;;
          esac
          
          if [ -n "$WEBHOOK" ] && [ -n "$MSG_ID" ]; then
            curl -X POST -H "Content-Type: application/json" \
              -d "{\"content\": \"$CONTENT –¥–ª—è message $MSG_ID\"}" \
              "$WEBHOOK"
          fi

      - name: Download and upload video
        id: download
        run: |
          LINK=$(yt-dlp \
            --retries 3 \
            --fragment-retries 3 \
            --sleep-interval 2 \
            --merge-output-format mp4 \
            --allow-unplayable-formats \
            --extractor-args "pinterest:use_webpage=True" \
            --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            --no-check-certificate \
            --output - \
            "${{ inputs.url }}" | \
            curl -s -H "Expect:" \
            -F "reqtype=fileupload" \
            -F "fileToUpload=@-;filename=video.mp4;type=video/mp4" \
            https://catbox.moe/user/api.php)
          
          if [[ "$LINK" =~ ^https:// ]]; then
            echo "link=$LINK" >> $GITHUB_OUTPUT
          else
            exit 1
          fi

      - name: Send result to Discord
        if: success()
        run: |
          LINK="${{ steps.download.outputs.link }}"
          MSG_ID="${{ inputs.message_id }}"
          WEBHOOK="${{ secrets.DISCORD_RESULTS_WEBHOOK }}"
          
          if [ -n "$LINK" ] && [ -n "$WEBHOOK" ] && [ -n "$MSG_ID" ]; then
            curl -X POST -H "Content-Type: application/json" \
              -d "{\"content\": \"‚úÖ [–ì–æ—Ç–æ–≤–æ!]($LINK) –¥–ª—è message $MSG_ID\"}" \
              "$WEBHOOK"
          fi
