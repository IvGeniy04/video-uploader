name: Fast Social Video Processor

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Video URL (Telegram, Facebook, TikTok, Pinterest, Instagram)'
        required: true
        type: string
      message_id:
        description: 'Discord message ID (optional)'
        required: false
        type: string

jobs:
  process-video:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup yt-dlp with FFmpeg (fast & cached)
        uses: AnimMouse/setup-yt-dlp@v3

      - name: Log incoming URL
        run: |
          echo "ðŸ”— URL: '${{ inputs.url }}'"
          if [ -z "${{ inputs.message_id }}" ]; then
            echo "ðŸ†” Message ID: [none provided]"
          else
            echo "ðŸ†” Message ID: '${{ inputs.message_id }}'"
          fi

      - name: Expand redirects
        id: resolve
        run: |
          FINAL=$(curl -Ls -o /dev/null -w '%{url_effective}' "${{ inputs.url }}")
          echo "FINAL_URL=$FINAL" >> $GITHUB_ENV
          echo "ðŸ” Resolved: $FINAL"

      - name: Download with audio if available
        id: download
        run: |
          echo "ðŸ“¥ Downloading from: '$FINAL_URL'"
          yt-dlp --verbose \
            --format "bestvideo[ext=mp4]+bestaudio[ext=m4a]/best" \
            --merge-output-format mp4 \
            --no-playlist \
            -o "video.%(ext)s" "$FINAL_URL"
          echo "ðŸ§¾ Downloaded files:"
          ls -lh video.*

      - name: Upload to Catbox
        id: upload
        run: |
          FILE=$(ls video.* | head -n1)
          echo "ðŸ“¤ Uploading $FILE to catbox..."
          LINK=$(curl -s -F "reqtype=fileupload" -F "file=@$FILE" https://catbox.moe/user/api.php)
          echo "ðŸ“¦ Catbox URL: $LINK"
          echo "link=$LINK" >> $GITHUB_OUTPUT
          rm -f video.*

      - name: Send message to Discord
        if: steps.upload.outputs.link
        run: |
          CONTENT="âœ… Video uploaded: ${{ steps.upload.outputs.link }}"
          if [ -n "${{ inputs.message_id }}" ]; then
            CONTENT="$CONTENT (reply to message ID: ${{ inputs.message_id }})"
          fi
          echo "ðŸ“£ Sending to Discord: $CONTENT"
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{\"content\":\"$CONTENT\"}"
