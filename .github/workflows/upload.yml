name: Upload Video to Catbox

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Video URL'
        required: true
        type: string
      message_id:
        description: 'Discord Message ID'
        required: false
        type: string

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Install yt-dlp with embedded ffmpeg
        run: |
          curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o yt-dlp
          chmod +x yt-dlp
          sudo mv yt-dlp /usr/local/bin/

      - name: Install requests
        run: |
          pip install requests

      - name: Warm up Facebook
        if: contains(inputs.url, 'facebook.com') || contains(inputs.url, 'fb.watch')
        run: |
          curl -s -L -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            --max-time 30 "${{ inputs.url }}" > /dev/null 2>&1 || true
          sleep 3

      - name: Download video (Attempt 1)
        id: download
        run: |
          yt-dlp \
            --format "bestvideo+bestaudio" \
            --merge-output-format mp4 \
            --retries 3 \
            --fragment-retries 3 \
            --sleep-interval 2 \
            --no-check-certificate \
            --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            --extractor-args "pinterest:use_webpage=True" \
            --output "video.mp4" \
            "${{ inputs.url }}" && \
          echo "status=success" >> $GITHUB_OUTPUT || \
          echo "status=failed" >> $GITHUB_OUTPUT

      - name: Upload to Catbox (Attempt 1)
        if: steps.download.outputs.status == 'success'
        id: upload
        run: |
          LINK=$(curl -s -H "Expect:" \
            -F "reqtype=fileupload" \
            -F "fileToUpload=@video.mp4" \
            https://catbox.moe/user/api.php)
          
          if [[ "$LINK" =~ ^https:// ]]; then
            echo "link=$LINK" >> $GITHUB_OUTPUT
            # –ù–∞–¥—Å–∏–ª–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
            curl -X POST -H "Content-Type: application/json" \
              -d "{\"content\": \"üîó $LINK –¥–ª—è message ${{ inputs.message_id }}\"}" \
              "${{ secrets.DISCORD_RESULTS_WEBHOOK }}"
            # –£—Å–ø—ñ—Ö
            curl -X POST -H "Content-Type: application/json" \
              -d "{\"content\": \"‚úÖ –¥–ª—è message ${{ inputs.message_id }}\"}" \
              "${{ secrets.DISCORD_RESULTS_WEBHOOK }}"
          else
            exit 1
          fi

      - name: Retry (Attempt 2)
        if: failure()
        run: |
          yt-dlp \
            --format "bestvideo+bestaudio" \
            --merge-output-format mp4 \
            --retries 3 \
            --fragment-retries 3 \
            --sleep-interval 2 \
            --no-check-certificate \
            --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            --extractor-args "pinterest:use_webpage=True" \
            --output "video.mp4" \
            "${{ inputs.url }}" && \
          LINK=$(curl -s -H "Expect:" -F "reqtype=fileupload" -F "fileToUpload=@video.mp4" https://catbox.moe/user/api.php) && \
          [[ "$LINK" =~ ^https:// ]] && \
          echo "link=$LINK" >> $GITHUB_OUTPUT && \
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"content\": \"üîó $LINK –¥–ª—è message ${{ inputs.message_id }}\"}" \
            "${{ secrets.DISCORD_RESULTS_WEBHOOK }}" && \
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"content\": \"‚úÖ –¥–ª—è message ${{ inputs.message_id }}\"}" \
            "${{ secrets.DISCORD_RESULTS_WEBHOOK }}" || \
          (curl -X POST -H "Content-Type: application/json" \
            -d "{\"content\": \"‚ùå –¥–ª—è message ${{ inputs.message_id }}\"}" \
            "${{ secrets.DISCORD_RESULTS_WEBHOOK }}"; exit 1)

      - name: Clean up
        if: always()
        run: |
          rm -f video.mp4
