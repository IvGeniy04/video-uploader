name: Upload Video to Catbox

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Video URL (TikTok, Instagram, etc.)'
        required: true
        type: string

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install yt-dlp requests

      - name: Check and upload video
        id: catbox
        run: |
          VIDEO_URL="${{ github.event.inputs.url }}"
          MAX_SIZE_BYTES=$((180 * 1024 * 1024))  # 180 MB

          echo "üîç –û—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –≤—ñ–¥–µ–æ..."
          INFO=$(yt-dlp --dump-json --format "best[height<=480][ext=mp4]" "$VIDEO_URL" 2>/dev/null)

          if [ -z "$INFO" ]; then
            echo "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≤—ñ–¥–µ–æ"
            curl -X POST -H "Content-Type: application/json" \
              -d '{"content": "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤—ñ–¥–µ–æ"}' \
              ${{ secrets.DISCORD_WEBHOOK }}
            exit 1
          fi

          FILESIZE=$(echo "$INFO" | python3 -c "import sys, json; print(json.load(sys.stdin).get('filesize', 0))")

          if [ -z "$FILESIZE" ] || [ "$FILESIZE" -eq 0 ]; then
            echo "‚ö†Ô∏è –†–æ–∑–º—ñ—Ä –Ω–µ–≤—ñ–¥–æ–º–∏–π ‚Äî –ø—Ä–æ–±—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏..."
          elif [ "$FILESIZE" -gt "$MAX_SIZE_BYTES" ]; then
            echo "‚ùå –í—ñ–¥–µ–æ –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–µ: $(echo "$FILESIZE" / 1024 / 1024 | cut -d. -f1) MB"
            curl -X POST -H "Content-Type: application/json" \
              -d '{"content": "‚ùå –í—ñ–¥–µ–æ –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–µ"}' \
              ${{ secrets.DISCORD_WEBHOOK }}
            exit 1
          fi

          echo "üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –≤–∏–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ Catbox..."
          OUTPUT_LINK=$(echo "$INFO" | yt-dlp --format "best[height<=480][ext=mp4]" --merge-output-format mp4 -o - --input-json - | \
            curl -H "Expect:" -F "reqtype=fileupload" -F "fileToUpload=@-;filename=video.mp4;type=video/mp4" https://catbox.moe/user/api.php)

          if [[ "$OUTPUT_LINK" =~ ^https:// ]]; then
            echo "‚úÖ –£—Å–ø—ñ—à–Ω–æ: $OUTPUT_LINK"
            echo "link=$OUTPUT_LINK" >> $GITHUB_OUTPUT
          else
            echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–∏–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: $OUTPUT_LINK"
            curl -X POST -H "Content-Type: application/json" \
              -d '{"content": "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–∞ Catbox"}' \
              ${{ secrets.DISCORD_WEBHOOK }}
            exit 1
          fi

      - name: Send success to Discord
        if: success()
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{"content": "üéûÔ∏è ${{ steps.catbox.outputs.link }}"}' \
          ${{ secrets.DISCORD_WEBHOOK }}
