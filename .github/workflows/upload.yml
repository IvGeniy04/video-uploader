name: Video Upload

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Video URL'
        required: true
        type: string
      message_id:
        description: 'Discord message ID (optional)'
        required: false
        type: string

jobs:
  download:
    runs-on: ubuntu-latest

    steps:
      - name: üßº Clean workspace
        run: rm -rf * .*

      - name: üì• Debug input URL
        run: |
          echo "üîó Received URL: '${{ inputs.url }}'"
          echo "üì© Message ID: '${{ inputs.message_id || 'None' }}'"

      - name: üß∞ Set up yt-dlp
        run: |
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod +x /usr/local/bin/yt-dlp
          yt-dlp --version

      - name: üé¨ Download video with audio
        env:
          FINAL_URL: ${{ inputs.url }}
        run: |
          echo "üì• Downloading from '${FINAL_URL}'"
          yt-dlp "$FINAL_URL" -f bestvideo+bestaudio --merge-output-format mp4 -o "video.%(ext)s"

      - name: üóÉÔ∏è Check downloaded files
        run: |
          ls -lh

      - name: ‚òÅÔ∏è Upload to Catbox
        id: catbox
        run: |
          FILE=$(ls video.* | head -n1)
          echo "Uploading $FILE to Catbox"
          RESPONSE=$(curl -s -F "reqtype=fileupload" -F "userhash=" -F "file=@$FILE" https://catbox.moe/user/api.php)
          echo "Catbox URL: $RESPONSE"
          echo "url=$RESPONSE" >> $GITHUB_OUTPUT

      - name: üì¢ Send to Discord webhook
        if: env.DISCORD_WEBHOOK != ''
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          MESSAGE="‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –≤—ñ–¥–µ–æ: ${{ steps.catbox.outputs.url }}"
          if [ -n "${{ inputs.message_id }}" ]; then
            MESSAGE="${MESSAGE}\nüîó –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: https://discord.com/channels/YOUR_SERVER_ID/YOUR_CHANNEL_ID/${{ inputs.message_id }}"
          fi

          echo "Sending message: $MESSAGE"
          curl -H "Content-Type: application/json" -X POST -d "{\"content\": \"$MESSAGE\"}" "$WEBHOOK_URL"
