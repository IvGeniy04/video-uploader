name: Upload Video with Sound

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Video URL (Tg/Fb/TikTok/Pinterest/Instagram)'
        required: true
        type: string
      message_id:
        description: 'Discord message ID (reply)'
        required: false
        type: string

jobs:
  download-upload:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup yt-dlp with FFmpeg
        uses: AnimMouse/setup-yt-dlp@v3

      - name: Resolve final URL
        id: resolve
        run: |
          URL="${{ github.event.inputs.url }}"
          FINAL=$(curl -Ls -o /dev/null -w '%{url_effective}' "$URL")
          echo "FINAL_URL=$FINAL" >> $GITHUB_ENV

- name: Download, merge audio+video, upload, and clean up
  id: catbox
  run: |
    echo "Downloading from $FINAL_URL..."

    yt-dlp --verbose --retries 2 --fragment-retries 2 \
      --format "bestvideo[ext=mp4]+bestaudio[ext=m4a]/bestvideo[ext=mp4]/best" \
      --merge-output-format mp4 \
      -o "video.%(ext)s" "$FINAL_URL"

    FILE=$(ls video.* | head -n1)
    if [ ! -f "$FILE" ]; then
      echo "❌ No merged or standalone video file found"
      exit 1
    fi

    echo "Uploading $FILE to Catbox..."
    LINK=$(curl -s -H "Expect:" \
      -F "reqtype=fileupload" -F "fileToUpload=@$FILE" \
      https://catbox.moe/user/api.php)

    if [[ $LINK == https://* ]]; then
      echo "link=$LINK" >> $GITHUB_OUTPUT
    else
      echo "❌ Upload failed: $LINK"
      exit 1
    fi

    rm -f video.*


      - name: Send to Discord
        if: steps.catbox.outputs.link
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          LINK="${{ steps.catbox.outputs.link }}"
          MSG_ID="${{ github.event.inputs.message_id }}"
          CONTENT="✅ Завантажено відео — $LINK"
          if [ -n "$MSG_ID" ]; then CONTENT="$CONTENT (replying to $MSG_ID)"; fi

          curl -X POST -H "Content-Type: application/json" \
            -d "{\"content\": \"$CONTENT\"}" \
            "$DISCORD_WEBHOOK"
