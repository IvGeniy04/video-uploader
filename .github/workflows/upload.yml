name: Upload Video
on:
  workflow_dispatch:
    inputs:
      url:
        description: 'URL to download'
        required: true
      message_id:
        description: 'Discord message ID (optional)'
        required: false

jobs:
  upload_video:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Cache yt-dlp
        uses: actions/cache@v4
        with:
          path: ~/.cache/yt-dlp
          key: yt-dlp-cache-${{ runner.os }}-${{ hashFiles('**/upload.yml') }}
          restore-keys: |
            yt-dlp-cache-${{ runner.os }}-

      - name: Set URL variable
        id: vars
        run: |
          FINAL_URL=$(curl -Ls -o /dev/null -w '%{url_effective}' "${{ github.event.inputs.url }}")
          echo "FINAL_URL=$FINAL_URL" >> $GITHUB_ENV
          echo "âœ… Resolved final URL: $FINAL_URL"

      - name: Clean previous videos
        run: rm -f video.*

      - name: Setup yt-dlp (with aria2)
        uses: AnimMouse/setup-yt-dlp@v3
        with:
          version: stable
          aria2: true

      - name: Download video with audio (best format)
        id: download
        run: |
          echo "ðŸ“¥ Downloading from: $FINAL_URL"
          yt-dlp --verbose --format "bestvideo[ext=mp4]+bestaudio[ext=m4a]/best" --merge-output-format mp4 --no-playlist -o "video.%(ext)s" "$FINAL_URL"
          ls -lh video.*
          FILE=$(ls video.* | head -n1)
          echo "FILE=$FILE" >> $GITHUB_ENV
          echo "âœ… Downloaded file: $FILE"

      - name: Upload to Catbox
        id: upload
        run: |
          echo "ðŸ§¾ Current directory files:"
          ls -lh
          echo "ðŸ“¤ Uploading $FILE to Catbox..."
          if [[ ! -f "$FILE" ]]; then
            echo "âŒ ERROR: File '$FILE' not found!"
            exit 1
          fi
          URL=$(curl -s -F "reqtype=fileupload" -F "file=@$FILE" https://catbox.moe/user/api.php)
          echo "URL=$URL" >> $GITHUB_OUTPUT
          echo "âœ… Uploaded URL: $URL"
          rm -f "$FILE"

      - name: Send result to Discord
        if: success()
        run: |
          CONTENT="âœ… Video uploaded: ${{ steps.upload.outputs.URL }}"
          echo "ðŸ“£ Sending to Discord: $CONTENT (reply to message ID: ${{ github.event.inputs.message_id || 'none' }})"
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"content\": \"$CONTENT\", \"message_reference\": {\"message_id\": \"${{ github.event.inputs.message_id || '' }}\"}}" \
            https://discord.com/api/webhooks/YOUR_WEBHOOK_URL_HERE
