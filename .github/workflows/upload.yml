name: Upload Video

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Video URL'
        required: true
        type: string
      message_id:
        description: 'Discord message ID'
        required: true
        type: string

jobs:
  download-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Set up yt-dlp cache
        id: yt-dlp-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/yt-dlp
          key: yt-dlp-cache

      - name: Install yt-dlp
        run: pip install -U yt-dlp

      - name: Set URL env
        run: |
          echo "FINAL_URL=${{ github.event.inputs.url }}" >> $GITHUB_ENV
          echo "MESSAGE_ID=${{ github.event.inputs.message_id }}" >> $GITHUB_ENV

      - name: Download, merge and upload to Catbox
        id: catbox
        run: |
          echo "Downloading from: $FINAL_URL"

          yt-dlp \
            --retries 2 \
            --merge-output-format mp4 \
            --output "output.%(ext)s" \
            "$FINAL_URL"

          FILE=$(ls output.* | head -n1)

          if [ ! -f "$FILE" ]; then
            echo "❌ No video file downloaded"
            exit 1
          fi

          echo "Uploading file: $FILE"

          RESPONSE=$(curl -s -H "Expect:" -F "reqtype=fileupload" -F "fileToUpload=@$FILE" https://catbox.moe/user/api.php)

          if [[ $RESPONSE == https://* ]]; then
            echo "✅ Uploaded to Catbox: $RESPONSE"
            echo "link=$RESPONSE" >> $GITHUB_OUTPUT
          else
            echo "❌ Failed to upload to Catbox"
            exit 1
          fi

      - name: Send to Discord
        if: ${{ steps.catbox.outputs.link }}
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          MESSAGE="✅ Завантажено відео: ${{ steps.catbox.outputs.link }} (відповідь на повідомлення ID: $MESSAGE_ID)"
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"$MESSAGE\"}" \
               "$DISCORD_WEBHOOK"
